services:
  garmin-mcp:
    build:
      context: .
      dockerfile: garmin.Dockerfile
    environment:
      PORT: "1234"
      GARMIN_EMAIL_FILE: "/run/secrets/garmin-email"
      GARMIN_PASSWORD_FILE: "/run/secrets/garmin-pw"
    secrets:
      - garmin-email
      - garmin-pw

  oauth2-proxy:
    build:
      context: .
      dockerfile: oauth2-proxy.Dockerfile
    ports:
      - "8080:8080"
    environment:
      PORT: "8080"
      OAUTH2_PROXY_AUTHENTICATED_EMAILS_FILE: "/run/secrets/oauth2-authenticated-emails"
      OAUTH2_PROXY_CLIENT_ID: ${OAUTH2_PROXY_CLIENT_ID}
      OAUTH2_PROXY_CLIENT_SECRET_FILE: "/run/secrets/oauth2-client-secret"
      OAUTH2_PROXY_COOKIE_SECRET_FILE: "/run/secrets/oauth2-cookie-secret"
      OAUTH2_PROXY_COOKIE_SECURE: "false"
      OAUTH2_PROXY_REDIRECT_URL: "http://localhost:8080/oauth2/callback"
      OAUTH2_PROXY_UPSTREAMS: "http://garmin-mcp:1234"
    secrets:
      - oauth2-authenticated-emails
      - oauth2-client-secret
      - oauth2-cookie-secret
    depends_on:
      garmin-mcp:
        condition: service_healthy

secrets:
  garmin-email:
    file: .secrets/garmin-email.txt
  garmin-pw:
    file: .secrets/garmin-pw.txt
  oauth2-authenticated-emails:
    file: .secrets/oauth2-authenticated-emails.txt
  oauth2-client-secret:
    file: .secrets/oauth2-client-secret.txt
  oauth2-cookie-secret:
    file: .secrets/oauth2-cookie-secret.bin
